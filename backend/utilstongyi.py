# tongyi_utils.py (v3.0 ä¿®å¤ç‰ˆ - åŸºäºtesttongyi.pyçš„æˆåŠŸå®ç°)
import os
from datetime import datetime
from dotenv import load_dotenv
from openai import OpenAI

# åŠ è½½.envç¯å¢ƒå˜é‡
load_dotenv()

# é€šä¹‰APIé…ç½®
TONGYI_API_ENDPOINT = "https://dashscope.aliyuncs.com/compatible-mode/v1"
TONGYI_API_KEY = os.getenv("TONGYI_API_KEY")


def analyze_video_with_tongyi_stream(video_url: str):
    """
    è°ƒç”¨é€šä¹‰åƒé—® qwen-vl-plus æ¨¡å‹åˆ†æè§†é¢‘å†…å®¹ï¼Œè¿”å›æµå¼ç”Ÿæˆå™¨ã€‚
    ç”¨äºStreamlitçš„æµå¼è¾“å‡ºæ˜¾ç¤ºã€‚
    """
    if not TONGYI_API_KEY:
        yield (
            "### âš ï¸ è¯·é…ç½® API å¯†é’¥\n\n"
            "æœªåœ¨ `.env` æ–‡ä»¶ä¸­æ‰¾åˆ° `TONGYI_API_KEY`ã€‚è¯·æ·»åŠ ï¼š\n\n"
            "```env\nTONGYI_API_KEY=ä½ çš„å¯†é’¥\n```"
        )
        return

    try:
        print(f"å¼€å§‹åˆ†æè§†é¢‘: {video_url}")

        # é¢„æ£€æŸ¥è§†é¢‘URL
        if not video_url or not video_url.startswith(('http://', 'https://')):
            yield (
                "## âŒ è§†é¢‘URLæ ¼å¼é”™è¯¯\n\n"
                f"**æä¾›çš„URL**: {video_url}\n\n"
                "### è¦æ±‚\n"
                "- URLå¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´\n"
                "- URLå¿…é¡»æŒ‡å‘æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶\n"
                "- å»ºè®®ä½¿ç”¨MP4æ ¼å¼\n"
            )
            return

        # åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯
        client = OpenAI(
            api_key=TONGYI_API_KEY,
            base_url=TONGYI_API_ENDPOINT
        )

        # è°ƒç”¨æµå¼API
        stream = client.chat.completions.create(
            model="qwen-vl-plus",
            messages=[
                {
                    "role": "system",
                    "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ•™è‚²å†…å®¹åˆ†æå¸ˆï¼Œæ“…é•¿åˆ†ææ•™å­¦è§†é¢‘å¹¶ç”Ÿæˆè¯¦ç»†çš„å­¦ä¹ æŒ‡å¯¼æŠ¥å‘Šã€‚è¯·æŒ‰ç…§ä»¥ä¸‹ç»“æ„åˆ†æè§†é¢‘ï¼š\n\n## ğŸ“¹ è§†é¢‘å†…å®¹åˆ†ææŠ¥å‘Š\n### ğŸ¯ æ ¸å¿ƒä¸»é¢˜\n### ğŸ“‹ å†…å®¹å¤§çº²\n### ğŸ”‘ å…³é”®çŸ¥è¯†ç‚¹\n### ğŸ“š å­¦ä¹ å»ºè®®\n### ğŸ“ æ•™å­¦è¯„ä»·"
                },
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": "è¯·è¯¦ç»†åˆ†æè¿™ä¸ªæ•™å­¦è§†é¢‘çš„å†…å®¹ï¼Œç”Ÿæˆç»“æ„åŒ–çš„å­¦ä¹ æŒ‡å¯¼æŠ¥å‘Šï¼š"},
                        {"type": "video_url", "video_url": video_url}
                    ]
                }
            ],
            temperature=0.5,
            stream=True  # å¯ç”¨æµå¼è¾“å‡º
        )

        # æµå¼è¿”å›å†…å®¹
        full_content = ""
        for chunk in stream:
            if chunk.choices[0].delta.content is not None:
                content = chunk.choices[0].delta.content
                full_content += content
                yield full_content

        print("âœ… æµå¼è§†é¢‘åˆ†æå®Œæˆ")

    except Exception as e:
        error_str = str(e)
        print(f"âŒ æµå¼è§†é¢‘åˆ†æå¼‚å¸¸: {error_str}")

        # ç‰¹æ®Šé”™è¯¯å¤„ç†
        if "too long" in error_str.lower():
            yield (
                "## â±ï¸ è§†é¢‘æ—¶é•¿è¶…é™\n\n"
                f"**è§†é¢‘é“¾æ¥**: {video_url}\n"
                f"**é”™è¯¯ä¿¡æ¯**: è§†é¢‘æ–‡ä»¶è¿‡é•¿ï¼Œè¶…å‡ºäº†APIå¤„ç†é™åˆ¶\n\n"
                "### è§£å†³æ–¹æ¡ˆ\n"
                "1. **è§†é¢‘å‰ªè¾‘**ï¼šå°†è§†é¢‘åˆ†å‰²æˆè¾ƒçŸ­çš„ç‰‡æ®µï¼ˆå»ºè®®æ¯æ®µ5-10åˆ†é’Ÿï¼‰\n"
                "2. **å…³é”®ç‰‡æ®µ**ï¼šé€‰æ‹©è§†é¢‘ä¸­æœ€é‡è¦çš„éƒ¨åˆ†è¿›è¡Œåˆ†æ\n"
                "3. **å‹ç¼©å¤„ç†**ï¼šé™ä½è§†é¢‘åˆ†è¾¨ç‡å’Œç ç‡\n\n"
                "### å»ºè®®çš„è§†é¢‘è§„æ ¼\n"
                "- **æ—¶é•¿**ï¼š5-15åˆ†é’Ÿä¸ºæœ€ä½³\n"
                "- **æ ¼å¼**ï¼šMP4æ ¼å¼\n"
                "- **åˆ†è¾¨ç‡**ï¼š720pæˆ–1080p\n"
                "- **æ–‡ä»¶å¤§å°**ï¼šå°äº100MB"
            )
        elif "download" in error_str.lower() or "access" in error_str.lower():
            yield (
                "## ğŸŒ è§†é¢‘è®¿é—®å¤±è´¥\n\n"
                f"**è§†é¢‘é“¾æ¥**: {video_url}\n"
                f"**é”™è¯¯ä¿¡æ¯**: APIæ— æ³•ä¸‹è½½æˆ–è®¿é—®è§†é¢‘æ–‡ä»¶\n\n"
                "### å¯èƒ½åŸå› \n"
                "1. **ç½‘ç»œé™åˆ¶**ï¼šè§†é¢‘URLå¯èƒ½æœ‰è®¿é—®é™åˆ¶\n"
                "2. **åŸŸåé—®é¢˜**ï¼šæŸäº›åŸŸåå¯èƒ½è¢«APIæœåŠ¡å•†é™åˆ¶\n"
                "3. **æ–‡ä»¶æƒé™**ï¼šè§†é¢‘æ–‡ä»¶å¯èƒ½éœ€è¦ç‰¹æ®Šæƒé™è®¿é—®\n\n"
                "### è§£å†³æ–¹æ¡ˆ\n"
                "1. **æ£€æŸ¥URL**ï¼šç¡®ä¿è§†é¢‘é“¾æ¥å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—®\n"
                "2. **æ›´æ¢åŸŸå**ï¼šå°è¯•ä½¿ç”¨ä¸ƒç‰›äº‘çš„CDNåŸŸå\n"
                "3. **å…¬å¼€æƒé™**ï¼šç¡®ä¿è§†é¢‘æ–‡ä»¶è®¾ç½®ä¸ºå…¬å¼€è®¿é—®\n"
                "4. **è”ç³»ç®¡ç†å‘˜**ï¼šæ£€æŸ¥ä¸ƒç‰›äº‘å­˜å‚¨æ¡¶çš„è®¿é—®è®¾ç½®"
            )
        else:
            yield (
                "## âŒ è§†é¢‘åˆ†æå¼‚å¸¸\n\n"
                f"**é”™è¯¯è¯¦æƒ…**:\n```\n{error_str}\n```\n\n"
                f"**è§†é¢‘é“¾æ¥**: {video_url}\n"
                f"**åˆ†ææ—¶é—´**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
                "### å¸¸è§é—®é¢˜æ’æŸ¥ï¼š\n"
                "1. **ç½‘ç»œè¿æ¥**ï¼šç¡®ä¿ç½‘ç»œç¨³å®šï¼Œå¯ä»¥è®¿é—®å¤–ç½‘\n"
                "2. **APIé…ç½®**ï¼šæ£€æŸ¥`.env`æ–‡ä»¶ä¸­çš„`TONGYI_API_KEY`æ˜¯å¦æ­£ç¡®\n"
                "3. **è§†é¢‘é“¾æ¥**ï¼šç¡®è®¤è§†é¢‘URLå¯ä»¥ç›´æ¥è®¿é—®\n"
                "4. **è§†é¢‘æ ¼å¼**ï¼šå»ºè®®ä½¿ç”¨MP4æ ¼å¼ï¼Œé¿å…ç‰¹æ®Šç¼–ç \n"
                "5. **æ–‡ä»¶å¤§å°**ï¼šé¿å…è¿‡å¤§çš„è§†é¢‘æ–‡ä»¶ï¼ˆå»ºè®®<100MBï¼‰\n"
                "6. **è§†é¢‘æ—¶é•¿**ï¼šæ§åˆ¶åœ¨15åˆ†é’Ÿä»¥å†…\n\n"
                "### æŠ€æœ¯æ”¯æŒ\n"
                "å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒå¹¶æä¾›ä¸Šè¿°é”™è¯¯ä¿¡æ¯ã€‚"
            )


def analyze_video_with_tongyi(video_url: str) -> str:
    """
    è°ƒç”¨é€šä¹‰åƒé—® qwen-vl-plus æ¨¡å‹åˆ†æè§†é¢‘å†…å®¹ï¼Œå¹¶è¿”å›ç»“æ„åŒ–Markdownæ–‡æœ¬ã€‚
    åŸºäºtesttongyi.pyçš„æˆåŠŸå®ç°æ–¹å¼ã€‚
    """
    if not TONGYI_API_KEY:
        return (
            "### âš ï¸ è¯·é…ç½® API å¯†é’¥\n\n"
            "æœªåœ¨ `.env` æ–‡ä»¶ä¸­æ‰¾åˆ° `TONGYI_API_KEY`ã€‚è¯·æ·»åŠ ï¼š\n\n"
            "```env\nTONGYI_API_KEY=ä½ çš„å¯†é’¥\n```"
        )

    try:
        print(f"å¼€å§‹åˆ†æè§†é¢‘: {video_url}")

        # é¢„æ£€æŸ¥è§†é¢‘URL
        if not video_url or not video_url.startswith(('http://', 'https://')):
            return (
                "## âŒ è§†é¢‘URLæ ¼å¼é”™è¯¯\n\n"
                f"**æä¾›çš„URL**: {video_url}\n\n"
                "### è¦æ±‚\n"
                "- URLå¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´\n"
                "- URLå¿…é¡»æŒ‡å‘æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶\n"
                "- å»ºè®®ä½¿ç”¨MP4æ ¼å¼\n"
            )

        # åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯ï¼ˆä½¿ç”¨é€šä¹‰åƒé—®çš„å…¼å®¹æ¥å£ï¼‰
        client = OpenAI(
            api_key=TONGYI_API_KEY,
            base_url=TONGYI_API_ENDPOINT
        )

        # è°ƒç”¨APIï¼ˆä½¿ç”¨ä¸testtongyi.pyç›¸åŒçš„ç®€åŒ–æ–¹å¼ï¼‰
        response = client.chat.completions.create(
            model="qwen-vl-plus",
            messages=[
                {
                    "role": "system",
                    "content": "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ•™è‚²å†…å®¹åˆ†æå¸ˆï¼Œæ“…é•¿åˆ†ææ•™å­¦è§†é¢‘å¹¶ç”Ÿæˆè¯¦ç»†çš„å­¦ä¹ æŒ‡å¯¼æŠ¥å‘Šã€‚è¯·æŒ‰ç…§ä»¥ä¸‹ç»“æ„åˆ†æè§†é¢‘ï¼š\n\n## ğŸ“¹ è§†é¢‘å†…å®¹åˆ†ææŠ¥å‘Š\n### ğŸ¯ æ ¸å¿ƒä¸»é¢˜\n### ğŸ“‹ å†…å®¹å¤§çº²\n### ğŸ”‘ å…³é”®çŸ¥è¯†ç‚¹\n### ğŸ“š å­¦ä¹ å»ºè®®\n### ğŸ“ æ•™å­¦è¯„ä»·"
                },
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": "è¯·è¯¦ç»†åˆ†æè¿™ä¸ªæ•™å­¦è§†é¢‘çš„å†…å®¹ï¼Œç”Ÿæˆç»“æ„åŒ–çš„å­¦ä¹ æŒ‡å¯¼æŠ¥å‘Šï¼š"},
                        {"type": "video_url", "video_url": video_url}
                    ]
                }
            ],
            temperature=0.5,
        )

        # æ£€æŸ¥å“åº”
        if hasattr(response.choices[0].message, 'content') and response.choices[0].message.content:
            result = response.choices[0].message.content.strip()
            print("âœ… è§†é¢‘åˆ†ææˆåŠŸå®Œæˆ")
            return result
        else:
            print("âŒ APIå“åº”æ ¼å¼å¼‚å¸¸")
            return (
                "## ğŸ“¹ è§†é¢‘åˆ†æå¤±è´¥\n\n"
                f"- è§†é¢‘é“¾æ¥: {video_url}\n"
                f"- åˆ†ææ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
                "### å¯èƒ½åŸå› \n"
                "1. è§†é¢‘æ ¼å¼ä¸æ”¯æŒï¼ˆå»ºè®®ä½¿ç”¨MP4æ ¼å¼ï¼‰\n"
                "2. è§†é¢‘é“¾æ¥æ— æ³•è®¿é—®ï¼ˆæ£€æŸ¥ç½‘ç»œè¿æ¥ï¼‰\n"
                "3. è§†é¢‘å†…å®¹è¿‡é•¿æˆ–æ— æ•ˆ\n"
                "4. APIå“åº”æ ¼å¼å¼‚å¸¸\n\n"
                "### è§£å†³å»ºè®®\n"
                "- ç¡®ä¿è§†é¢‘é“¾æ¥å¯ä»¥å…¬ç½‘è®¿é—®\n"
                "- ä½¿ç”¨æ ‡å‡†çš„MP4æ ¼å¼\n"
                "- æ§åˆ¶è§†é¢‘æ—¶é•¿åœ¨1-60åˆ†é’Ÿå†…\n"
                "- æ£€æŸ¥ç½‘ç»œè¿æ¥ç¨³å®šæ€§"
            )

    except Exception as e:
        error_str = str(e)
        print(f"âŒ è§†é¢‘åˆ†æå¼‚å¸¸: {error_str}")

        # ç‰¹æ®Šé”™è¯¯å¤„ç†
        if "too long" in error_str.lower():
            return (
                "## â±ï¸ è§†é¢‘æ—¶é•¿è¶…é™\n\n"
                f"**è§†é¢‘é“¾æ¥**: {video_url}\n"
                f"**é”™è¯¯ä¿¡æ¯**: è§†é¢‘æ–‡ä»¶è¿‡é•¿ï¼Œè¶…å‡ºäº†APIå¤„ç†é™åˆ¶\n\n"
                "### è§£å†³æ–¹æ¡ˆ\n"
                "1. **è§†é¢‘å‰ªè¾‘**ï¼šå°†è§†é¢‘åˆ†å‰²æˆè¾ƒçŸ­çš„ç‰‡æ®µï¼ˆå»ºè®®æ¯æ®µ5-10åˆ†é’Ÿï¼‰\n"
                "2. **å…³é”®ç‰‡æ®µ**ï¼šé€‰æ‹©è§†é¢‘ä¸­æœ€é‡è¦çš„éƒ¨åˆ†è¿›è¡Œåˆ†æ\n"
                "3. **å‹ç¼©å¤„ç†**ï¼šé™ä½è§†é¢‘åˆ†è¾¨ç‡å’Œç ç‡\n\n"
                "### å»ºè®®çš„è§†é¢‘è§„æ ¼\n"
                "- **æ—¶é•¿**ï¼š5-15åˆ†é’Ÿä¸ºæœ€ä½³\n"
                "- **æ ¼å¼**ï¼šMP4æ ¼å¼\n"
                "- **åˆ†è¾¨ç‡**ï¼š720pæˆ–1080p\n"
                "- **æ–‡ä»¶å¤§å°**ï¼šå°äº100MB"
            )
        elif "download" in error_str.lower() or "access" in error_str.lower():
            return (
                "## ğŸŒ è§†é¢‘è®¿é—®å¤±è´¥\n\n"
                f"**è§†é¢‘é“¾æ¥**: {video_url}\n"
                f"**é”™è¯¯ä¿¡æ¯**: APIæ— æ³•ä¸‹è½½æˆ–è®¿é—®è§†é¢‘æ–‡ä»¶\n\n"
                "### å¯èƒ½åŸå› \n"
                "1. **ç½‘ç»œé™åˆ¶**ï¼šè§†é¢‘URLå¯èƒ½æœ‰è®¿é—®é™åˆ¶\n"
                "2. **åŸŸåé—®é¢˜**ï¼šæŸäº›åŸŸåå¯èƒ½è¢«APIæœåŠ¡å•†é™åˆ¶\n"
                "3. **æ–‡ä»¶æƒé™**ï¼šè§†é¢‘æ–‡ä»¶å¯èƒ½éœ€è¦ç‰¹æ®Šæƒé™è®¿é—®\n\n"
                "### è§£å†³æ–¹æ¡ˆ\n"
                "1. **æ£€æŸ¥URL**ï¼šç¡®ä¿è§†é¢‘é“¾æ¥å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—®\n"
                "2. **æ›´æ¢åŸŸå**ï¼šå°è¯•ä½¿ç”¨ä¸ƒç‰›äº‘çš„CDNåŸŸå\n"
                "3. **å…¬å¼€æƒé™**ï¼šç¡®ä¿è§†é¢‘æ–‡ä»¶è®¾ç½®ä¸ºå…¬å¼€è®¿é—®\n"
                "4. **è”ç³»ç®¡ç†å‘˜**ï¼šæ£€æŸ¥ä¸ƒç‰›äº‘å­˜å‚¨æ¡¶çš„è®¿é—®è®¾ç½®"
            )
        else:
            return (
                "## âŒ è§†é¢‘åˆ†æå¼‚å¸¸\n\n"
                f"**é”™è¯¯è¯¦æƒ…**:\n```\n{error_str}\n```\n\n"
                f"**è§†é¢‘é“¾æ¥**: {video_url}\n"
                f"**åˆ†ææ—¶é—´**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
                "### å¸¸è§é—®é¢˜æ’æŸ¥ï¼š\n"
                "1. **ç½‘ç»œè¿æ¥**ï¼šç¡®ä¿ç½‘ç»œç¨³å®šï¼Œå¯ä»¥è®¿é—®å¤–ç½‘\n"
                "2. **APIé…ç½®**ï¼šæ£€æŸ¥`.env`æ–‡ä»¶ä¸­çš„`TONGYI_API_KEY`æ˜¯å¦æ­£ç¡®\n"
                "3. **è§†é¢‘é“¾æ¥**ï¼šç¡®è®¤è§†é¢‘URLå¯ä»¥ç›´æ¥è®¿é—®\n"
                "4. **è§†é¢‘æ ¼å¼**ï¼šå»ºè®®ä½¿ç”¨MP4æ ¼å¼ï¼Œé¿å…ç‰¹æ®Šç¼–ç \n"
                "5. **æ–‡ä»¶å¤§å°**ï¼šé¿å…è¿‡å¤§çš„è§†é¢‘æ–‡ä»¶ï¼ˆå»ºè®®<100MBï¼‰\n"
                "6. **è§†é¢‘æ—¶é•¿**ï¼šæ§åˆ¶åœ¨15åˆ†é’Ÿä»¥å†…\n\n"
                "### æŠ€æœ¯æ”¯æŒ\n"
                "å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒå¹¶æä¾›ä¸Šè¿°é”™è¯¯ä¿¡æ¯ã€‚"
            )


def get_video_info(video_url: str) -> dict:
    """
    åŸºäº HEAD è¯·æ±‚æ£€æŸ¥è§†é¢‘æ˜¯å¦å¯è®¿é—® + æœåŠ¡å™¨ä¿¡æ¯
    """
    import requests
    from urllib.parse import urlparse

    try:
        parsed = urlparse(video_url)
        response = requests.head(video_url, timeout=10)

        return {
            "url": video_url,
            "domain": parsed.netloc,
            "status": response.status_code,
            "type": response.headers.get("Content-Type", "æœªçŸ¥"),
            "length": response.headers.get("Content-Length", "æœªçŸ¥"),
            "accessible": response.status_code == 200
        }
    except Exception as e:
        return {
            "url": video_url,
            "error": str(e),
            "accessible": False
        } 